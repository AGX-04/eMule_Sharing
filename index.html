<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>eMule 分享 - AGX-04 归档</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify/themes/vue.css" />
  <style>
    /* --- ED2K 链接复制按钮自定义样式 --- */
    .ed2k-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
        flex-wrap: wrap;
    }
    .ed2k-link {
        flex-grow: 1;
        word-break: break-all;
        margin-right: 10px;
        font-size: 0.9em;
    }
    .copy-btn {
        background-color: #2ea44f;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        flex-shrink: 0;
        white-space: nowrap;
    }
    .copy-btn:hover {
        background-color: #2c974b;
    }
    .copy-btn:active {
        background-color: #298e46;
    }
    /* 移动端响应式，使 ED2K 链接在小屏幕下垂直排列 */
    @media (max-width: 768px) {
        .ed2k-container {
            flex-direction: column;
            align-items: flex-start;
        }
        .ed2k-link {
            margin-right: 0;
            margin-bottom: 8px;
            width: 100%;
        }
        .copy-btn {
            width: 100%;
            text-align: center;
        }
    }
  </style>
</head>
<body>
  <div id="app">加载中...</div>

  <script>
    // --- 自定义函数：复制文本到剪贴板 ---
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Optional: visual feedback
        }, function(err) {
            console.error('无法复制文本：', err);
            alert('无法复制链接，请手动复制。');
        });
    }

    // --- Docsify 配置 ---
    window.$docsify = {
      name: 'eMule 分享',
      repo: 'AGX-04/eMule_Sharing',
      
      // *** 关键修复：明确指定 _sidebar.md 的路径 ***
      loadSidebar: '_sidebar.md', 

      subMaxLevel: 4, // 确保所有层级都被渲染

      // Docsify-sidebar-collapse 插件配置
      sidebarCollapse: {
        accordion: false,
        collapseIcon: '-',
        expandIcon: '+'
      },

      // --- Docsify 生命周期钩子：在每次页面内容渲染后执行 ---
      afterEach: function(html, next) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const ed2kLinks = doc.querySelectorAll('a[href^="ed2k://"]');

          ed2kLinks.forEach(link => {
              if (link.closest('.ed2k-container')) {
                  return;
              }
              const linkHref = link.href;
              const linkText = link.textContent;
              const container = doc.createElement('div');
              container.className = 'ed2k-container';
              const linkSpan = doc.createElement('span');
              linkSpan.className = 'ed2k-link';
              const actualLink = doc.createElement('a'); 
              actualLink.href = linkHref;
              actualLink.textContent = linkText || linkHref;
              linkSpan.appendChild(actualLink);
              const copyButton = doc.createElement('button');
              copyButton.className = 'copy-btn';
              copyButton.textContent = '复制链接';
              copyButton.onclick = (e) => {
                  e.preventDefault(); 
                  copyToClipboard(linkHref);
              };
              container.appendChild(linkSpan);
              container.appendChild(copyButton);
              link.parentNode.replaceChild(container, link);
          });
          next(doc.documentElement.outerHTML);
      },

      // --- 调试钩子：确认侧边栏处理情况 ---
      doneEach: function() {
          console.log('--- Docsify doneEach Hook Fired ---');
          const sidebarNav = document.querySelector('.sidebar-nav');
          if (sidebarNav) {
              console.log('Sidebar nav element found:', sidebarNav);
              const parentListItems = sidebarNav.querySelectorAll('li:has(ul)');
              console.log(`LI elements with nested ULs (potential collapsible parents): ${parentListItems.length}`);
              parentListItems.forEach(li => {
                  const link = li.querySelector('a');
                  const icon = li.querySelector('.sidebar-toggle-icon');
                  console.log(`LI Text: "${link ? link.textContent.trim() : li.textContent.trim().split('\n')[0]}"`);
                  console.log('  Has <a> tag:', !!link);
                  console.log('  Has .sidebar-toggle-icon (should be true if plugin works):', !!icon);
                  console.log('  LI classes:', li.classList.value);
              });
          } else {
              console.warn('Sidebar nav element NOT found. Docsify sidebar might not be rendered.');
          }
      }
    };
  </script>
  <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-copy-code/dist/docsify-copy-code.min.js"></script>
</body>
</html>