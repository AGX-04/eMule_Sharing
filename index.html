<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>eMule 分享 - AGX-04 归档</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify/themes/vue.css" />
  <style>
    /* --- ED2K 链接复制按钮自定义样式 --- */
    .ed2k-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
        flex-wrap: wrap; /* 允许换行 */
    }
    .ed2k-link {
        flex-grow: 1; /* 链接占据可用空间 */
        word-break: break-all; /* 长链接自动换行 */
        margin-right: 10px;
        font-size: 0.9em;
    }
    .copy-btn {
        background-color: #2ea44f;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        flex-shrink: 0; /* 按钮不收缩 */
        white-space: nowrap; /* 按钮文字不换行 */
    }
    .copy-btn:hover {
        background-color: #2c974b;
    }
    .copy-btn:active {
        background-color: #298e46;
    }
    /* 移动端响应式，使 ED2K 链接在小屏幕下垂直排列 */
    @media (max-width: 768px) {
        .ed2k-container {
            flex-direction: column;
            align-items: flex-start;
        }
        .ed2k-link {
            margin-right: 0;
            margin-bottom: 8px;
            width: 100%;
        }
        .copy-btn {
            width: 100%;
            text-align: center;
        }
    }
  </style>
</head>
<body>
  <div id="app">加载中...</div>

  <script>
    // --- 自定义函数：复制文本到剪贴板 ---
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // 复制成功后可以在这里添加一个短暂的提示
        }, function(err) {
            console.error('无法复制文本：', err);
            alert('无法复制链接，请手动复制。');
        });
    }

    // --- Docsify 配置 ---
    window.$docsify = {
      name: 'eMule 分享',
      repo: 'AGX-04/eMule_Sharing',
      loadSidebar: true,

      // 确保所有层级都被渲染出来
      subMaxLevel: 4, 

      // Docsify-sidebar-collapse 插件配置
      // 注意：这里的配置会被插件读取，但插件的实际应用可能在 Docsify 钩子中
      sidebarCollapse: {
        accordion: false,
        collapseIcon: '-',
        expandIcon: '+'
      },

      // --- Docsify 生命周期钩子：在每次页面内容渲染后执行 ---
      afterEach: function(html, next) {
          // 处理 ED2K 链接复制按钮
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const ed2kLinks = doc.querySelectorAll('a[href^="ed2k://"]');

          ed2kLinks.forEach(link => {
              if (link.closest('.ed2k-container')) {
                  return;
              }

              const linkHref = link.href;
              const linkText = link.textContent;

              const container = doc.createElement('div');
              container.className = 'ed2k-container';

              const linkSpan = doc.createElement('span');
              linkSpan.className = 'ed2k-link';
              const actualLink = doc.createElement('a'); 
              actualLink.href = linkHref;
              actualLink.textContent = linkText || linkHref;
              linkSpan.appendChild(actualLink);

              const copyButton = doc.createElement('button');
              copyButton.className = 'copy-btn';
              copyButton.textContent = '复制链接';
              copyButton.onclick = (e) => {
                  e.preventDefault(); 
                  copyToClipboard(linkHref);
              };

              container.appendChild(linkSpan);
              container.appendChild(copyButton);

              link.parentNode.replaceChild(container, link);
          });

          next(doc.documentElement.outerHTML);
      },

      // --- 新增钩子：在Docsify完成所有渲染（包括侧边栏）后执行 ---
      doneEach: function() {
          console.log('Docsify doneEach hook fired. Attempting to initialize sidebar collapse plugin.');
          // 插件通常会在 Docsify 渲染完成后自动初始化。
          // 但如果不行，我们可以尝试获取侧边栏元素并检查。
          const sidebarNav = document.querySelector('.sidebar-nav');
          if (sidebarNav) {
              console.log('Sidebar nav element found in doneEach.');
              const listItemsWithNestedUls = sidebarNav.querySelectorAll('li:has(ul)');
              console.log(`Found ${listItemsWithNestedUls.length} list items with nested ULs.`);

              listItemsWithNestedUls.forEach(li => {
                  const link = li.querySelector('a');
                  if (link) {
                      // 如果插件没有自动添加图标，这里可以手动检查和添加
                      // 但理想情况下，插件应该自己做这个。
                      // 这个 console.log 旨在确认我们能找到正确的元素
                      console.log('Processing LI with nested UL:', li.textContent.trim());
                      // 检查该 li 是否有我们希望插件添加的类，例如 'active', 'folder', 'has-sub' 等
                      // 以及是否有图标元素。
                  }
              });

              // 注意： docsify-sidebar-collapse 插件自身没有一个公共的 re-initialize 方法。
              // 它被设计为在 Docsify 的 router:afterEach 或其他渲染生命周期中自动运行。
              // 如果它没有工作，那说明它的自动触发逻辑没有被 Docsify 正常调用，
              // 或者它在 DOM 中找不到它需要的特定选择器。

              // 最后的尝试：触发一个自定义事件，看插件是否监听
              // (Docsify插件通常不这样工作，但作为调试尝试)
              // var event = new Event('docsify:sidebar:update');
              // document.dispatchEvent(event);

          } else {
              console.warn('Sidebar nav element NOT found in doneEach. Sidebar might not be fully rendered yet, or its CSS class is different.');
          }
      }
    };
  </script>
  <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-copy-code/dist/docsify-copy-code.min.js"></script>
</body>
</html>